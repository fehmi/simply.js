<template>

  <div id="editor">
    <ul id="file-tabs">
      <each data.files as file>
        {file.filename}
      </each>
      <!--<li filename="index.html" class="selected" onclick="changeSelectedFile(event)">index.html</li>-->
    </ul>
    <slot name="files" ref:navslot></slot>
    <ul id="files">

      <li filename="hello-world.html">
        <textarea>
          <template>
            hello world
          </template>
        </textarea>
      </li>
    </ul>

  </div>
  <div id="result">
    <iframe id="result"></iframe>
    <div id="console"></div>
  </div>
</template>


<style>
  :host {
    display: flex;
    width: 960px;
    height: 450px;
  }

  #editor {
    display: flex;
    flex-direction: column;
    width: 65%;
  }

  #result {
    width: 35%;
  }

  #file-tabs,
  #files {
    display: flex;
    list-style: none;
    padding: 0px;
    margin: 0px;
  }

  #file-tabs li.selected {
    font-weight: 600;
  }

  #files,
  #editor textarea {
    flex: 1;
  }

  #files li {
    width: 100%;
    display: none;
  }

  #files li.selected {
    display: block;
  }

  #files li,
  #files textarea,
  iframe#result {
    width: 100%;
    height: 100%;
  }
</style>

<script>
  class {
    data = {
      files: []
    }
    methods = {
      render() {
        var slot = component.dom.querySelector('slot');
        var indexContent = slot.assignedNodes()[0].querySelector("textarea").value;

        var files = component.methods.rewriteGet("index.html", indexContent, 0).reverse();
        var blobs = [];
        var regex = /get\(.*,(\s+)?("|')(.*)("|')(\s+)?\)/gm;
        for (let index = 0; index < files.length; index++) {
          const element = files[index];
          for (const filename in element) {
            if (blobs[filename] == undefined) {
              var content = element[filename];
              let m;

              while ((m = regex.exec(content)) !== null) {
                // This is necessary to avoid infinite loops with zero-width matches
                if (m.index === regex.lastIndex) {
                  regex.lastIndex++;
                }
                content = content.replace(m[3], blobs[m[3]].blobUrl);
              }

              var blob = new Blob([content], { type: "text/html; charset=utf-8" });
              var blobUrl = URL.createObjectURL(blob);
              //content = content.replace(filename, blobUrl);

              blobs[filename] = {
                filename: filename,
                blobUrl: blobUrl,
                content: content
              };
            }
          }
        }
        // debug için script'in başına template ve style kadar \n koysam
        // satır numarasını tutturabilir miyim?
        component.dom.querySelector("iframe").srcdoc = blobs["index.html"].content;
        console.log(blobs);
      },
      rewriteGet(filename, content, i) {
        var slot = component.dom.querySelector('slot');
        // var indexContent = slot.assignedNodes()[0].querySelector("textarea").value;        
        var regex = /get\(.*,(\s+)?("|')(.*)("|')(\s+)?\)/gm;
        var regex2 = /get\(.*,(\s+)?("|')(.*)("|')(\s+)?\)/gm;
        var blobs = "";

        if (!component.files) {
          component.files = [];
        }

        if (!component.files[i]) {
          component.files[i] = {};
        }

        let m;
        let mm;

        while ((m = regex.exec(content)) !== null) {
          // This is necessary to avoid infinite loops with zero-width matches
          if (m.index === regex.lastIndex) {
            regex.lastIndex++;
          }
          var fn = m[3];
          var nestedComponentContent = slot.assignedNodes()[0].querySelector("textarea[filename=" + fn.replace(/\./g, "\\.") + "] ").value;

          while ((mm = regex2.exec(content)) !== null) {
            var nnestedComponentContent = slot.assignedNodes()[0].querySelector("textarea[filename=" + mm[3].replace(/\./g, "\\.") + "] ").value;
            component.methods.rewriteGet(mm[3], nnestedComponentContent, i + 1);
          }
        }
        component.files[i][filename] = content;
        return component.files;
      },
      changeSelectedFile(event) {
        component.dom.querySelector("#file-tabs .selected").classList.remove("selected");
        component.dom.querySelector("#files .selected").classList.remove("selected");
        event.target.classList.add("selected");

        var filename = event.target.getAttribute("filename").replace(/\./g, "\\.");
        component.dom.querySelector("#files [filename=" + filename + "]").classList.add("selected");
      }
    }
    lifecycle = {
      afterFirstRender() {
        var slot = component.dom.querySelector('slot');
        var files = slot.assignedNodes()[0].querySelectorAll("textarea");

          for (let index = 0; index < files.length; index++) {
            var fileEl = files[index];
            var filename = fileEl.getAttribute("filename");
            var fileContent = fileEl.value;
            var isFileSelected = fileEl.hasAttribute("selected");
            data.files.push({
              filename: filename,
              content: fileContent,
              selected: isFileSelected
            })

          }

        component.methods.render();
      },
      beforeFirstRender(template) {
        // burada template'i editleyip
        // return edebilirim
      }
    }
  }
</script>